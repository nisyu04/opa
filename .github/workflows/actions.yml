name: policy-validation

on:
  pull_request:
    paths:
      - '**/*.yaml'

jobs:
  validate:
    runs-on: self-hosted
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
      
    - name: Get changed files
      id: changes
      run: |
        git fetch origin main
        git diff --name-only origin/main > changed.txt

    - name: Run conftest
      run: |
        GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}"

        CODEOWNER=nisyu04
        PR_NUMBER=${{ github.event.pull_request.number }}

        REVIEWERS=$(curl -L -H "Accept: application/vnd.github+json" -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/requested_reviewers)
        REVIEWER_NAME=$(echo "$REVIEWERS" | jq -r '.users[0].login')
        
        YAML_FILE=$(mktemp).yaml
        cat <<EOF > "$YAML_FILE"
        reviewer:
          owner: $CODEOWNER
          _user: $REVIEWER_NAME
        EOF
        cat $YAML_FILE
        echo "Code Owner Reviewer " $CODEOWNER $REVIEWER_NAME
        while IFS= read -r file; do
          if [[ "$file" == *.yaml || "$file" == *.yml ]]; then
            conftest test "$file" --data $YAML_FILE
          fi
        done < changed.txt
        rm -f $YAML_FILE
        rm -f changed.txt