name: policy-validation

on:
  pull_request:
    paths:
      - '**/*.yaml'

jobs:
  validate:
    runs-on: self-hosted
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3
      
    - name: Get changed files
      id: changes
      run: |
        git fetch origin main
        git diff --name-only origin/main > changed.txt

    - name: Run conftest
      run: |
        OWNER="${{ github.repository_owner }}"
        REPO="${{ github.repository }}"
        GITHUB_TOKEN="${{ secrets.GITHUB_TOKEN }}"
        CODEOWNERS_PATH=".github/CODEOWNERS"

        curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
         -H "Accept: application/vnd.github.v3.raw" \
         "https://api.github.com/repos/$OWNER/$REPO/contents/$CODEOWNERS_PATH" \
         -o codeowners.txt
        CODEOWNER=$(grep -v '^#' codeowners.txt | head -n 1 | grep -o "@[^ ]*")
        PR_NUMBER=${{ github.event.pull_request.number }}

        REVIEWERS=$(curl -s \
          -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/pulls/${PR_NUMBER}}/requested_reviewers")
        
        REVIEWER_NAME=$(echo "$REVIEWERS" | jq -r '.users[0].login')
        
        echo "REVIEWER_NAME=$REVIEWER_NAME" >> $GITHUB_ENV
        YAML_FILE=$(mktemp).yaml
        cat <<EOF > "$YAML_FILE"
        reviewer:
          owner: $CODEOWNER
          _user: $REVIEWER_NAME
        EOF
        while IFS= read -r file; do
          if [[ "$file" == *.yaml || "$file" == *.yml ]]; then
            conftest test "$file" --data $YAML_FILE
          fi
        done < changed.txt
        rm -f $YAML_FILE